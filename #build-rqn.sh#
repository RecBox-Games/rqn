#!/bin/bash

set -e

# First Time Setup (TODO: test)
if [[ $1 == "--first" ]]; then
    # node
    apt install node
    
    # rust/cargo
    apt install -y curl
    curl https://sh.rustup.rs -sSf | sh
    source $HOME/.cargo/env

    # Control pad build dependencies
    apt install -y libpulse-dev libasound2-dev portaudio19-dev build-essential libdbus-1-dev
    apt install -y libudev-dev

    apt install -y xclip

    echo "Do a 'ssh-keygen -t rsa -b 4096' then cat /root/.ssh/id_rsa.pub | 'xclip -selection c'"
    echo "This should generate a public key and copy it to your clipboard."
    echo "paste public key in SSH keys in github.com's Settings/"
    echo "(make sure that weston has given you access to repositories)"
fi


git-get() {
    dir="$1"
    repo="$2"
    rbg="RecBox-Games"
    src="${3-$rbg}"
    cd $dir
    if [ -d $repo ]; then
	cd $repo
	git pull
    else
	git clone git@github.com:$src/$repo.git
	cd $repo
    fi
}


base="/home/requin"

working="$base/dev"
dest="$base/target-rqn"

if [ ! -d $dest ]; then
    git clone git@github.com:westonkelliher/rqn.git $dest
    cd $dest
    git checkout testing
fi

if [ ! -z "$(ls $dest)" ]; then
    rm -r $dest/*
fi


# Control Pad Server
echo "----- WSCPServ -----"
git-get $working WSCPServ
cargo build --release
cp target/release/server $dest/cp_server

# Node Web Server
echo "----- WebCP -----"
git-get $working WebCP
mkdir $dest/webcp
cp index.* $dest/webcp/
cp package.json $dest/webcp/

# System Software (Loader and System)
echo "----- SystemApps -----"
git-get $working SystemApps
cargo build --release
cp index.html $dest/
cp target/release/loader $dest/
cp target/release/system $dest/
cp -r resources $dest/

mkdir $dest/games

# KeyWords Game
echo "----- KeyWords -----"
git-get $working KeyWords westonkelliher
cargo build --release
mkdir $dest/games/keywords
cp meta.txt $dest/games/keywords/
# cp index.html $dest/games/keywords/
cp target/release/keywords $dest/games/keywords/
cp -r words $dest/
cp -r resources $dest/games/keywords/

# Copy Scripts and Setup Files
echo "----- Scripts -----"
git-get $working rqn-scripts
echo "cp $working/rqn-scripts/* $dest/"
cp $working/rqn-scripts/.bashrc $dest/
cp $working/rqn-scripts/.xinitrc $dest/
cp $working/rqn-scripts/* $dest/
if [ -f $dest/build-rqn.sh ]; then
    rm $dest/build-rqn.sh
fi
